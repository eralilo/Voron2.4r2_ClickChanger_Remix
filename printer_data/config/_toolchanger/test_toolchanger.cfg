[gcode_macro TEST_TOOLCHANGER]
description: Cycles through tools T0 to T3. Usage: TEST_TOOLCHANGER ITERATIONS=10 RANDOMIZE=1
gcode:
    # 1. Parameters
    {% set ITERATIONS = params.ITERATIONS|default(1)|int %}
    {% set SPEED = params.SPEED|default(15000)|int %}
    {% set RANDOMIZE = params.RANDOMIZE|default(0)|int %}
    
    # 2. Safety Checks
    {% if printer.toolhead.homed_axes != "xyz" %}
        {action_raise_error("Must home XYZ before running tool changer test!")}
    {% endif %}

    # 3. Start Loop
    M117 Starting {ITERATIONS} cycles...
    RESPOND MSG="Starting tool changer test: {ITERATIONS} iterations (Random: {'Yes' if RANDOMIZE else 'No'})."

    {% for i in range(ITERATIONS) %}
        RESPOND MSG="Cycle {i + 1} of {ITERATIONS}"
        
        # Determine the tool sequence for this iteration
        {% set tool_list = [0, 1, 2, 3] %}
        {% if RANDOMIZE %}
            # Simple pseudo-random shuffle via selection
            {% set tool_sequence = tool_list|shuffle %}
        {% else %}
            {% set tool_sequence = tool_list %}
        {% endif %}

        {% for tool_num in tool_sequence %}
            M117 Cycle {i+1}: Selecting T{tool_num}
            T{tool_num}
            
            # Move to a "check zone" to ensure tool is locked and clear of dock
            G0 X150 Y150 Z50 F{SPEED}
            G4 P500 
        {% endfor %}
    {% endfor %}

    M117 Test Complete
    T0
    G0 X150 Y150 Z100 F{SPEED}