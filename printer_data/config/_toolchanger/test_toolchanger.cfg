[gcode_macro TEST_TOOLCHANGER]
description: Cycles through tools T0 to T3. Usage: TEST_TOOLCHANGER ITERATIONS=10 RANDOMIZE=1
gcode:
    # 1. Parameters
    {% set ITERATIONS = params.ITERATIONS|default(1)|int %}
    {% set SPEED = params.SPEED|default(15000)|int %}
    {% set RANDOMIZE = params.RANDOMIZE|default(0)|int %}
    
    # 2. Safety Checks
    {% if printer.toolhead.homed_axes != "xyz" %}
        {action_raise_error("Must home XYZ before running tool changer test!")}
    {% endif %}

    # 3. Start Loop
    M117 Starting {ITERATIONS} cycles...
    
    {% for i in range(ITERATIONS) %}
        RESPOND MSG="Cycle {i + 1} of {ITERATIONS}"
        
        # If not random, just do 0, 1, 2, 3
        {% if not RANDOMIZE %}
            {% set sequence = [0, 1, 2, 3] %}
        {% else %}
            # For "Random", we use the loop index to create different sequences
            # This isn't 'true' random, but it varies the order each cycle.
            {% if i % 4 == 0 %}
                {% set sequence = [3, 1, 0, 2] %}
            {% elif i % 4 == 1 %}
                {% set sequence = [0, 2, 3, 1] %}
            {% elif i % 4 == 2 %}
                {% set sequence = [2, 0, 1, 3] %}
            {% else %}
                {% set sequence = [1, 3, 2, 0] %}
            {% endif %}
        {% endif %}

        {% for tool_num in sequence %}
            M117 Cycle {i+1}: Selecting T{tool_num}
            T{tool_num}
            
            # Move to a "check zone" 
            G0 X150 Y150 Z50 F{SPEED}
            G4 P500 
        {% endfor %}
    {% endfor %}

    M117 Test Complete
    T0
    G0 X150 Y150 Z100 F{SPEED}