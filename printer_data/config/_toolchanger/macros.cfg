

[gcode_macro _TAP_PROBE_ACTIVATE]
description: Ensure safe temp for bed probing
gcode:
    {% set max_temp = 160 %}
    {% set actual_temp = printer[params.HEATER].temperature %}
    {% set target_temp = printer[params.HEATER].target %}
    {% if target_temp > max_temp %}
        { action_respond_info('Extruder temperature target of %.1fC is too high, lowering to %.1fC' % (target_temp, max_temp)) }
        SET_HEATER_TEMPERATURE HEATER={params.HEATER} TARGET={ max_temp }
    {% endif %}
    # Temperature target is already low enough, but nozzle may still be too hot.
    {% if actual_temp > max_temp  + 5 %}
        { action_respond_info('Extruder temperature %.1fC is still too high, waiting until below %.1fC' % (actual_temp, max_temp)) }
        TEMPERATURE_WAIT SENSOR={params.HEATER} MAXIMUM={ max_temp }
    {% endif %}

[gcode_macro M104]
rename_existing: M104.1
description: [T<index>] [S<temperature>]
  Set tool temperature.
  T= Tool number, optional. If this parameter is not provided, the current tool is used.
  S= Target temperature
gcode:
  {% if params.T is defined %}
    {% set newparameters = "" %}
    {% set newparameters = newparameters ~ " T="~params.T %}
    {% if params.S is defined %}
      {% set newparameters = newparameters ~ " TARGET="~params.S %}
    {% endif %}
    SET_TOOL_TEMPERATURE{newparameters}
  {% else %}
    M104.1 {rawparams}
  {% endif %}

#[gcode_macro M109]
#rename_existing: M109.1
#description: [T<index>] [S<temperature>]
#  Set tool temperature and wait.
#  T= Tool number, optional. If this parameter is not provided, the current tool is used.
#  S= Target temperature
#gcode:
#  {% if params.T is defined %}
#    {% set newparameters = "" %}
#    {% set newparameters = newparameters ~ " T="~params.T %}
#    {% if params.S is defined %}
#      {% set newparameters = newparameters ~ " TARGET="~params.S %}
#    {% endif %}
#    SET_TOOL_TEMPERATURE WAIT=1 {newparameters}
#  {% else %}
#    M109.1 {rawparams}
#  {% endif %}

[gcode_macro M109]
rename_existing: M109.1
description: Set tool temperature and wait using TEMPERATURE_WAIT.
gcode:
  {% if params.T is defined %}
    {% set tool_index = params.T|int %}
    {% set target_temp = params.S|default(0)|float %}
    
    # 1. Map T index to the actual sensor name in your config
    # This assumes T0 is 'extruder', T1 is 'extruder1', etc.
    {% set sensor_name = "extruder" if tool_index == 0 else "extruder" ~ tool_index %}

    # 2. Set the temperature (non-blocking call to your toolchanger logic)
    SET_TOOL_TEMPERATURE T={tool_index} TARGET={target_temp}
    
    # 3. Use TEMPERATURE_WAIT to block until the target is reached
    # We use a small window (target to target + 2) for reliability
    {% if target_temp > 0 %}
        TEMPERATURE_WAIT SENSOR={sensor_name} MINIMUM={target_temp -2} MAXIMUM={target_temp + 2}
    {% endif %}

  {% else %}
    # If no T is provided, fall back to Klipper's native M109
    M109.1 {rawparams}
  {% endif %}